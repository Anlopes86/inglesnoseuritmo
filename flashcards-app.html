<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flash-English Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg-deep: #0f172a; --bg-card: #1e293b; --accent: #facc15; --text-main: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-deep); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }
        
        .flashcard { height: 350px; perspective: 1000px; cursor: pointer; width: 100%; max-width: 450px; margin: 0 auto; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            display: flex; align-items: center; justify-content: center; flex-direction: column; 
            padding: 2.5rem; border-radius: 2.5rem; border: 4px solid #334155; text-align: center; 
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.3);
        }
        .flashcard-front { background: var(--bg-card); color: var(--accent); font-size: 2.2rem; font-weight: 900; }
        .flashcard-back { background: var(--accent); color: var(--bg-deep); transform: rotateY(180deg); font-size: 1.5rem; font-weight: 700; }
        
        #loading-overlay { position: fixed; inset: 0; background: var(--bg-deep); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23facc15'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1.2em; padding-right: 2.5rem !important; }
    </style>
</head>
<body class="flex flex-col">

    <div id="loading-overlay">
        <i class="fas fa-bolt text-yellow-400 text-6xl mb-6 animate-bounce"></i>
        <p class="text-xl font-black uppercase tracking-widest">Sincronizando Conteúdo</p>
        <p id="load-status" class="text-slate-500 mt-2 font-mono text-sm">Aguardando...</p>
    </div>

    <header class="p-4 bg-slate-900 border-b border-slate-800 sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-xl font-bold text-yellow-400"><i class="fas fa-bolt mr-2"></i>FLASH-ENGLISH</h1>
            
            <div class="flex flex-wrap justify-center gap-2">
                <select id="moduleSelect" class="bg-slate-800 text-white p-3 rounded-xl border border-slate-700 font-bold text-sm outline-none">
                    <option value="all">TODOS OS MÓDULOS</option>
                    <option value="A1">MÓDULO A1 / A2</option>
                    <option value="VOC_CONV">VOCABULÁRIO DE CONVERSAÇÃO</option>
                    <option value="AULAS_CONV">AULAS DE CONVERSAÇÃO (HTML)</option>
                    <option value="EXP">EXPRESSÕES EXTRAS</option>
                </select>
                <select id="lessonFilter" class="bg-slate-800 text-white p-3 rounded-xl border border-slate-700 font-bold text-sm outline-none min-w-[150px]">
                    <option value="all">Todas as Lições</option>
                </select>
            </div>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center p-6">
        <div id="card-count-display" class="mb-6 bg-slate-800 px-4 py-1 rounded-full text-slate-400 font-bold text-xs tracking-widest border border-slate-700 uppercase">
            0 Cards
        </div>
        
        <div class="flashcard" id="flashcard" onclick="this.classList.toggle('flipped')">
            <div class="flashcard-inner">
                <div class="flashcard-front" id="frontText">...</div>
                <div class="flashcard-back" id="backText">...</div>
            </div>
        </div>

        <button onclick="showRandomCard()" class="mt-12 bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-black px-16 py-5 rounded-2xl text-xl transition-all shadow-xl active:scale-95">
            PRÓXIMO CARD <i class="fas fa-arrow-right ml-2"></i>
        </button>
    </main>

    <script>
        let fullDatabase = [];
        let filteredDB = [];
        const moduleSelect = document.getElementById('moduleSelect');
        const lessonFilter = document.getElementById('lessonFilter');
        const statusText = document.getElementById('load-status');

        async function init() {
            // 1. Carregar Expressões e Vocabulários JS
            statusText.innerText = "Lendo bases de dados...";
            await fetchAndParseJS('js/expressions.js', 'EXP');
            await fetchAndParseJS('js/vocabulary.js', 'A1');
            await fetchAndParseJS('js/conversation-vocabulary.js', 'VOC_CONV');

            // 2. Carregar Aulas de Conversação (HTML) sequencialmente como na sua primeira versão
            statusText.innerText = "Sincronizando Aulas de Conversação...";
            for (let i = 1; i <= 32; i++) {
                const num = i.toString().padStart(2, '0');
                try {
                    const response = await fetch(`conversation/licao-${num}.html`);
                    if (response.ok) {
                        const html = await response.text();
                        parseHTML(html, `AULAS_CONV-L${num}`, 'AULAS_CONV');
                    }
                } catch (e) { console.warn("Pulo lição " + num); }
            }

            // Finalizar
            document.getElementById('loading-overlay').style.display = 'none';
            populateFilters();
            filterAndShow();
        }

        async function fetchAndParseJS(file, moduleTag) {
            try {
                const resp = await fetch(file);
                if (!resp.ok) return;
                const text = await resp.text();
                const jsonStr = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = new Function(`return ${jsonStr}`)();
                
                for (let id in data) {
                    const lessonNum = id.toString().padStart(2, '0');
                    const label = `${moduleTag}-L${lessonNum}`;
                    if (moduleTag === 'EXP') {
                        data[id].forEach(e => fullDatabase.push({f: e.expression, b: e.meaning, m: 'EXP', l: id.toUpperCase()}));
                    } else {
                        data[id].words?.forEach(w => fullDatabase.push({f: w.english, b: w.portuguese, m: moduleTag, l: label}));
                        data[id].expressions?.forEach(e => fullDatabase.push({f: e.english, b: e.portuguese, m: moduleTag, l: label}));
                    }
                }
            } catch (e) {}
        }

        function parseHTML(html, label, moduleTag) {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const cards = doc.querySelectorAll('.flashcard');
            cards.forEach(card => {
                let f = card.querySelector('.flashcard-front h4')?.innerText || card.querySelector('.flashcard-front')?.innerText;
                let b = card.querySelector('.flashcard-back p')?.innerText || card.querySelector('.flashcard-back')?.innerText;
                if (f && b) {
                    f = f.trim().replace(/\n/g, ' ');
                    b = b.trim().replace(/\n/g, ' ');
                    if(!fullDatabase.some(d => d.f === f)) {
                        fullDatabase.push({f, b, m: moduleTag, l: label});
                    }
                }
            });
        }

        function populateFilters() {
            const mod = moduleSelect.value;
            const availableLessons = fullDatabase
                .filter(i => mod === 'all' || i.m === mod)
                .map(i => i.l);

            const uniqueSorted = [...new Set(availableLessons)].sort((a, b) => 
                a.localeCompare(b, undefined, {numeric: true})
            );
            
            lessonFilter.innerHTML = '<option value="all">Todas as Lições</option>';
            uniqueSorted.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l;
                opt.textContent = l;
                lessonFilter.appendChild(opt);
            });
        }

        function filterAndShow() {
            const mod = moduleSelect.value;
            const les = lessonFilter.value;
            filteredDB = fullDatabase.filter(i => (mod === 'all' || i.m === mod) && (les === 'all' || i.l === les));
            document.getElementById('card-count-display').innerText = `${filteredDB.length} Cards Disponíveis`;
            showRandomCard();
        }

        function showRandomCard() {
            if (filteredDB.length === 0) return;
            document.getElementById('flashcard').classList.remove('flipped');
            const card = filteredDB[Math.floor(Math.random() * filteredDB.length)];
            setTimeout(() => {
                document.getElementById('frontText').innerHTML = `<span class="text-xs text-gray-500 absolute top-6 uppercase tracking-widest">${card.l}</span>${card.f}`;
                document.getElementById('backText').innerText = card.b;
            }, 100);
        }

        moduleSelect.onchange = () => { populateFilters(); filterAndShow(); };
        lessonFilter.onchange = filterAndShow;

        init();
    </script>
</body>
</html>